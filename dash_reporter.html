
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Proyectos Mineros</title>
    <!-- Chart.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <!-- XLSX for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF and autotable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fb;
            color: #333;
        }
        header {
            background: #0055A6;
            color: white;
            padding: 1rem 2rem;
        }
        h1 {
            margin: 0;
            font-size: 1.6rem;
        }
        main {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .form-section {
            margin-bottom: 20px;
        }
        .form-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        select, button, input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .projects-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e7ff;
            padding: 10px;
            border-radius: 6px;
            background: #fafbff;
        }
        .projects-list label {
            display: block;
            margin-bottom: 5px;
        }
        .preview {
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
            border-top: 1px solid #e0e7ff;
            padding-top: 20px;
        }
        .download-buttons {
            margin-top: 10px;
            display: none;
        }
        .download-buttons button {
            margin-right: 10px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #0055A6;
            color: white;
            cursor: pointer;
        }
        .download-buttons button:hover {
            background: #004080;
        }
        /* Nuevos estilos para filtros y selección de gráficos */
        .filter-group {
            margin-bottom: 10px;
        }
        .filter-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .capex-filter {
            display: flex;
            gap: 10px;
        }
        .capex-filter input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        #apply-filters {
            background: #f0f5ff;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            color: #0055A6;
            cursor: pointer;
            margin-top: 5px;
        }
        #apply-filters:hover {
            background: #e0e7ff;
        }
        #chart-options label {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Reporte Ejecutivo de Proyectos</h1>
    </header>
    <main>
        <!-- Barra superior con menú de navegación, contadores, búsqueda y botones de exportación -->
        <div id="top-bar" class="top-bar" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
            <div style="display:flex; align-items:center; gap:15px;">
                <a href="dash.html" id="dash-link" style="color:#0055A6; font-weight:600; text-decoration:underline;">Volver al Dashboard</a>
                <div id="kpi-container" style="display:flex; gap:15px; font-size:0.85rem;">
                    <span id="kpi-total">0 proyectos</span>
                    <span id="kpi-selected">0 seleccionados</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <input type="text" id="search-input" placeholder="Buscar por nombre..." style="padding:6px 8px; border:1px solid #ccc; border-radius:6px; font-size:0.85rem;">
                <!-- Botones de exportación en la barra superior. Se muestran al generar un reporte -->
                <!-- Botones de exportación siempre visibles pero deshabilitados hasta que se genere un reporte -->
                <button id="pdf-btn-top" style="display:inline-block; padding:6px 10px; background:#0055A6; color:white; border:none; border-radius:6px; font-size:0.85rem; cursor:pointer;" disabled>PDF</button>
                <button id="excel-btn-top" style="display:inline-block; padding:6px 10px; background:#0055A6; color:white; border:none; border-radius:6px; font-size:0.85rem; cursor:pointer;" disabled>Excel</button>
                <button id="word-btn-top" style="display:inline-block; padding:6px 10px; background:#0055A6; color:white; border:none; border-radius:6px; font-size:0.85rem; cursor:pointer;" disabled>Word</button>
            </div>
        </div>
        <section class="form-section">
            <label for="data-source">Datos</label>
            <input type="file" id="data-source" accept=".xlsx,.xls,.json">
            <button type="button" id="load-data-btn" style="display:none; padding:6px 10px; background:#E60028; color:white; border:none; border-radius:6px; font-size:0.85rem; cursor:pointer; margin-top:4px;">Aceptar</button>
            <small>Puedes cargar un archivo Excel (.xlsx) o JSON exportado del administrador. También se intentará cargar automáticamente <em>proyectos.xlsx</em> de la raíz del servidor o desde LocalStorage.</small>
        </section>
        <section class="form-section">
            <label for="report-type">Tipo de reporte</label>
            <select id="report-type">
                <option value="comparativo">Comparativo</option>
                <option value="capexSector">CAPEX por Sector</option>
                <option value="proyectosPais">Proyectos por País</option>
                <option value="inversionEmpresa">Inversión por Compañía</option>
            </select>
        </section>
        <!-- Panel de filtros para refinar los proyectos mostrados en la lista.  
             Permite seleccionar sector, país, etapa, estado y rangos de CAPEX.  -->
        <section class="form-section" id="filters-section">
            <label>Filtros</label>
            <div class="filter-group">
                <label for="filter-sector">Sector</label>
                <select id="filter-sector">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-pais">País</label>
                <select id="filter-pais">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-etapa">Etapa</label>
                <select id="filter-etapa">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-estado">Estado</label>
                <select id="filter-estado">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>CAPEX (US$ MM)</label>
                <div class="capex-filter">
                    <input type="number" id="filter-capex-min" placeholder="Mínimo">
                    <input type="number" id="filter-capex-max" placeholder="Máximo">
                </div>
            </div>
            <button type="button" id="apply-filters">Aplicar filtros</button>
        </section>
        <!-- Panel de selección de gráficos para personalizar el reporte.  
             El usuario puede activar o desactivar gráficos específicos.  -->
        <section class="form-section" id="chart-selection-section">
            <label>Gráficos a incluir</label>
            <div id="chart-options"></div>
        </section>
        <section class="form-section">
            <label>Selecciona proyectos</label>
            <div id="projects-list" class="projects-list"></div>
        </section>
        <button id="generate-btn">Generar Reporte</button>
        <div id="report-preview" class="preview"></div>
        <div id="download-buttons" class="download-buttons">
            <button id="pdf-btn">PDF</button>
            <button id="excel-btn">Excel</button>
            <button id="word-btn">Word</button>
        </div>
    </main>
    <script>
    // Paleta de colores predeterminada para gráficos sencillos
    const palette = ['#0055A6','#E60028','#003366','#9b59b6','#2ecc71','#1abc9c','#34495e','#e67e22','#16a085','#27ae60'];
    // Variables globales
    let projects = [];
    let currentReportData = null;

    // Lista de proyectos filtrados. Si está vacía, se utiliza la lista completa.
    let filteredProjects = [];

    // Archivo pendiente de carga seleccionado por el usuario.  Se cargará al pulsar "Aceptar".
    let pendingFile = null;

    // Término de búsqueda para filtrar proyectos por nombre.
    let searchTerm = '';

    // Configuración de gráficos disponibles y selección actual.  Se rellenará dinámicamente
    // en renderChartOptions según el tipo de reporte y las preferencias del usuario.
    let chartSelection = {};
    const allCharts = {
        sector: 'CAPEX por Sector',
        top: 'Top Proyectos por CAPEX',
        stacked: 'Distribución de Etapas por Sector',
        company: 'Inversión por Compañía',
        country: 'Proyectos por País'
    };

    // Convierte cadenas separadas por comas o arrays en arrays limpios
    function toArray(val) {
        if (Array.isArray(val)) return val;
        if (typeof val === 'string' && val.trim()) {
            return val.split(',').map(s => s.trim()).filter(Boolean);
        }
        return [];
    }

    /*
     * Actualiza los contadores mostrados en la barra superior: total de proyectos disponibles
     * (tras aplicar filtros y búsqueda) y número de proyectos actualmente seleccionados.
     */
    function updateKPIs() {
        const totalEl = document.getElementById('kpi-total');
        const selEl = document.getElementById('kpi-selected');
        let base = (filteredProjects && filteredProjects.length) ? filteredProjects : projects;
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            base = base.filter(p => (p.name || '').toLowerCase().includes(term));
        }
        const total = base ? base.length : 0;
        if (totalEl) totalEl.textContent = total + ' proyectos';
        let selected = 0;
        document.querySelectorAll('#projects-list input[type="checkbox"]').forEach(cb => {
            if (cb.checked) selected++;
        });
        if (selEl) selEl.textContent = selected + ' seleccionados';
    }
    // Carga proyectos desde LocalStorage o desde archivos remotos
    async function loadInitialData() {
        try {
            // Intentar cargar desde localStorage (exportado por admin)
            const stored = localStorage.getItem('proyectosMineros') || localStorage.getItem('projectsData');
            if (stored) {
                projects = JSON.parse(stored);
                renderProjectsList();
                // Poblamos los filtros con los valores cargados
                populateFilters();
                return;
            }
        } catch (e) {}
        // Intentar cargar proyectos.xlsx
        try {
            const res = await fetch('proyectos.xlsx');
            if (res.ok) {
                const arrayBuffer = await res.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                projects = jsonData.map(row => normalizeRow(row));
        renderProjectsList();
        populateFilters();
        updateKPIs();
        return;
            }
        } catch (e) { console.error('No se pudo cargar proyectos.xlsx', e); }
        // Intentar proyectos.json
        try {
            const resJ = await fetch('proyectos.json');
            if (resJ.ok) {
                const data = await resJ.json();
                projects = data.map(row => normalizeRow(row));
                renderProjectsList();
                populateFilters();
                return;
            }
        } catch (e) { console.error('No se pudo cargar proyectos.json', e); }
        // Si falla todo, cargar ejemplo
        projects = [
            { name: 'Proyecto Cobre Andino', sector: 'Cobre', area: 'Norte', pais: 'Chile', etapa: 'Exploración', capex: 1500, companias: ['Minera Andes SA','Cobre Global'], productos: 'Cobre, Oro', estado: 'En evaluación' },
            { name: 'Mina de Oro Dorada', sector: 'Oro', area: 'Centro', pais: 'Perú', etapa: 'Producción', capex: 3200, companias: ['OroPerú SAC','GoldCorp'], productos: 'Oro, Plata', estado: 'Producción' },
            { name: 'Hierro del Sur', sector: 'Hierro', area: 'Sur', pais: 'Brasil', etapa: 'Construcción', capex: 4500, companias: ['Vale SA','Minera Brasileira'], productos: 'Hierro', estado: 'Construcción' },
            { name: 'Proyecto Plata Norte', sector: 'Plata', area: 'Norte', pais: 'México', etapa: 'Factibilidad', capex: 2800, companias: ['Peñoles','Silver Resources'], productos: 'Plata, Zinc', estado: 'En estudio' }
        ];
        renderProjectsList();
        populateFilters();
    }

    // Normaliza filas de un Excel/JSON a los campos usados
    function normalizeRow(row) {
        return {
            name: row.name || row.Nombre || row['Nombre del proyecto'] || row.Project || '',
            sector: row.sector || row.Sector || '',
            area: row.area || row.Área || row.Area || '',
            pais: row.pais || row.País || row.Country || '',
            etapa: row.etapa || row.Etapa || '',
            estado: row.estado || row.Estado || '',
            capex: parseFloat(row.capex || row['Capex (US$ mn)'] || row['CAPEX'] || 0),
            companias: toArray(row.companias || row['Compañías'] || row['Compañías relacionadas'] || row.Empresas || row.Company || ''),
            productos: toArray(row.productos || row.Productos || row['Productos y Servicios'] || '')
        };
    }

    /*
     * Pobla los selectores de filtros con los valores únicos disponibles en la lista
     * de proyectos.  Este método se invoca después de cargar los datos para que
     * el usuario pueda filtrar por sector, país, etapa, estado y rangos de CAPEX.
     */
    function populateFilters() {
        const sectors = new Set();
        const countries = new Set();
        const etapas = new Set();
        const estados = new Set();
        projects.forEach(p => {
            if (p.sector) sectors.add(p.sector);
            if (p.pais) countries.add(p.pais);
            if (p.etapa) etapas.add(p.etapa);
            if (p.estado) estados.add(p.estado);
        });
        const setSelect = (id, values) => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const firstOption = sel.querySelector('option');
            const firstText = firstOption ? firstOption.textContent : 'Todos';
            sel.innerHTML = '';
            const baseOpt = document.createElement('option');
            baseOpt.value = '';
            baseOpt.textContent = firstText;
            sel.appendChild(baseOpt);
            Array.from(values).sort((a,b) => a.localeCompare(b)).forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
            });
        };
        setSelect('filter-sector', sectors);
        setSelect('filter-pais', countries);
        setSelect('filter-etapa', etapas);
        setSelect('filter-estado', estados);
    }

    /*
     * Filtra la lista de proyectos según los valores seleccionados en el panel
     * de filtros.  Si no se aplican filtros, la lista completa se utiliza.
     */
    function applyFilters() {
        const sSec = document.getElementById('filter-sector').value;
        const sPais = document.getElementById('filter-pais').value;
        const sEtapa = document.getElementById('filter-etapa').value;
        const sEstado = document.getElementById('filter-estado').value;
        const minCapex = parseFloat(document.getElementById('filter-capex-min').value);
        const maxCapex = parseFloat(document.getElementById('filter-capex-max').value);
        filteredProjects = projects.filter(p => {
            if (sSec && p.sector !== sSec) return false;
            if (sPais && p.pais !== sPais) return false;
            if (sEtapa && p.etapa !== sEtapa) return false;
            if (sEstado && p.estado !== sEstado) return false;
            if (!isNaN(minCapex) && p.capex < minCapex) return false;
            if (!isNaN(maxCapex) && p.capex > maxCapex) return false;
            return true;
        });
        renderProjectsList();
        updateKPIs();
    }

    /*
     * Construye la lista de opciones de gráficos en función del tipo de reporte
     * seleccionado y establece la selección por defecto para cada tipo.  El
     * usuario puede activar o desactivar cada gráfico individualmente.
     */
    function renderChartOptions(reportType) {
        const container = document.getElementById('chart-options');
        if (!container) return;
        container.innerHTML = '';
        let defaults = [];
        if (reportType === 'comparativo') {
            defaults = Object.keys(allCharts);
        } else if (reportType === 'capexSector') {
            defaults = ['sector'];
        } else if (reportType === 'proyectosPais') {
            defaults = ['country'];
        } else if (reportType === 'inversionEmpresa') {
            defaults = ['company'];
        }
        chartSelection = {};
        Object.keys(allCharts).forEach(key => {
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.id = 'chart-' + key;
            cb.dataset.chart = key;
            cb.checked = defaults.includes(key);
            chartSelection[key] = cb.checked;
            cb.addEventListener('change', function() {
                chartSelection[this.dataset.chart] = this.checked;
            });
            const label = document.createElement('label');
            label.appendChild(cb);
            label.appendChild(document.createTextNode(' ' + allCharts[key]));
            container.appendChild(label);
        });
    }

    // Renderiza la lista de proyectos como checkboxes
    function renderProjectsList() {
        const list = document.getElementById('projects-list');
        list.innerHTML = '';
        // Seleccionamos la fuente de datos: filtrada o completa
        let source = (filteredProjects && filteredProjects.length) ? filteredProjects : projects;
        // Aplicar búsqueda por nombre si se ingresó un término
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            source = source.filter(p => (p.name || '').toLowerCase().includes(term));
        }
        if (!source || !source.length) {
            list.innerHTML = '<em>No hay proyectos disponibles</em>';
            updateKPIs();
            return;
        }
        // Ordenar por nombre para una presentación más ordenada
        const sorted = [...source].sort((a,b) => a.name.localeCompare(b.name));
        sorted.forEach((p, idx) => {
            const id = 'proj-' + idx;
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = p.name;
            checkbox.id = id;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + p.name));
            list.appendChild(label);
            // Actualizar contadores cuando se selecciona o deselecciona
            checkbox.addEventListener('change', updateKPIs);
        });
        // Actualizar los KPI una vez que se renderiza la lista
        updateKPIs();
    }

    // Función para generar la imagen de un gráfico con Chart.js
    async function generateChartImage(config) {
        return new Promise(resolve => {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            let chart = null;
            try {
                chart = new Chart(ctx, config);
            } catch (err) {
                console.error('Error creando gráfico', err);
                resolve(null);
                return;
            }
            // Esperar un breve momento para que Chart.js dibuje el gráfico correctamente
            setTimeout(() => {
                try {
                    if (chart && typeof chart.update === 'function') {
                        chart.update();
                    }
                    // Obtener la imagen desde el canvas asociado al gráfico
                    const img = chart && chart.canvas ? chart.canvas.toDataURL('image/png') : canvas.toDataURL('image/png');
                    chart && chart.destroy();
                    resolve(img);
                } catch (e) {
                    console.error('Error generando imagen de gráfico', e);
                    chart && chart.destroy();
                    resolve(null);
                }
            }, 300);
        });
    }

    /*
     * --- Gráficos sin dependencias externas ---
     * Las bibliotecas CDN pueden estar bloqueadas en algunos entornos. Para garantizar
     * que los gráficos se generen siempre, implementamos funciones para dibujar
     * diagramas de barras sencillos directamente sobre un canvas.  Estos gráficos
     * abarcan tanto barras horizontales como verticales y utilizan colores
     * basados en la paleta definida o generados dinámicamente en formato HSL.
     */
    // Convierte un valor HSL a código hexadecimal. Se utiliza para generar colores
    function hslToHex(h, s, l) {
        h /= 360;
        s /= 100;
        l /= 100;
        let r, g, b;
        if (s === 0) {
            r = g = b = l;
        } else {
            const hue2rgb = (p, q, t) => {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1 / 6) return p + (q - p) * 6 * t;
                if (t < 1 / 2) return q;
                if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                return p;
            };
            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            r = hue2rgb(p, q, h + 1 / 3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1 / 3);
        }
        const toHex = x => {
            const hex = Math.round(x * 255).toString(16).padStart(2, '0');
            return hex;
        };
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    // Crea un gráfico de barras sencillo (horizontal o vertical) y devuelve su imagen base64
    function createBarChart(labels, values, title, horizontal = false) {
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 400;
        const ctx = canvas.getContext('2d');
        // Fondo blanco
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        // Título
        ctx.fillStyle = '#0055A6';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(title, 20, 30);
        // Área de gráfico
        const margin = 60;
        const chartWidth = canvas.width - margin * 2;
        const chartHeight = canvas.height - margin * 2;
        const maxVal = Math.max(...values, 1);
        const count = labels.length;
        for (let i = 0; i < count; i++) {
            // Elegir color: usar la paleta si existe y, si se queda corta, generar colores en HSL
            let color;
            if (typeof palette !== 'undefined' && palette[i % palette.length]) {
                color = palette[i % palette.length];
            } else {
                color = hslToHex((i * 360) / count, 60, 60);
            }
            if (horizontal) {
                const barHeight = (chartHeight / count) * 0.6;
                const y = margin + i * (chartHeight / count);
                const barLength = (values[i] / maxVal) * chartWidth;
                ctx.fillStyle = color;
                ctx.fillRect(margin, y + (chartHeight / count - barHeight) / 2, barLength, barHeight);
                ctx.fillStyle = '#333333';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(labels[i], margin - 8, y + chartHeight / count / 2 + 4);
                ctx.textAlign = 'left';
                ctx.fillText(values[i], margin + barLength + 5, y + chartHeight / count / 2 + 4);
            } else {
                const barWidth = (chartWidth / count) * 0.6;
                const x = margin + i * (chartWidth / count) + ((chartWidth / count - barWidth) / 2);
                const barHeight = (values[i] / maxVal) * chartHeight;
                const y = margin + chartHeight - barHeight;
                ctx.fillStyle = color;
                ctx.fillRect(x, y, barWidth, barHeight);
                ctx.fillStyle = '#333333';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                // Valor sobre la barra
                ctx.fillText(values[i], x + barWidth / 2, y - 4);
                // Etiqueta debajo
                ctx.fillText(labels[i], x + barWidth / 2, margin + chartHeight + 15);
            }
        }
        return canvas.toDataURL('image/png');
    }

    // Genera el reporte a partir de los proyectos seleccionados y tipo
    async function generateReport() {
        const reportType = document.getElementById('report-type').value;
        const selectedNames = [];
        document.querySelectorAll('#projects-list input[type="checkbox"]:checked').forEach(cb => selectedNames.push(cb.value));
        if (!selectedNames.length) {
            alert('Selecciona al menos un proyecto');
            return;
        }
        // Determinamos la fuente base de proyectos (filtrados o completos) para la selección
        const source = (filteredProjects && filteredProjects.length) ? filteredProjects : projects;
        const selectedProjects = source.filter(p => selectedNames.includes(p.name));
        // Métricas
        const totalCapex = selectedProjects.reduce((sum,p)=> sum + (p.capex || 0), 0);
        const avgCapex = selectedProjects.length ? totalCapex / selectedProjects.length : 0;
        const sectores = new Set();
        const paises = new Set();
        const etapas = new Set();
        const estados = new Set();
        const empresas = new Set();
        selectedProjects.forEach(p => {
            if (p.sector) sectores.add(p.sector);
            if (p.pais) paises.add(p.pais);
            if (p.etapa) etapas.add(p.etapa);
            if (p.estado) estados.add(p.estado);
            toArray(p.companias).forEach(c => empresas.add(c));
        });
        let summaryHtml = '';
        summaryHtml += `<p><strong>Proyectos seleccionados:</strong> ${selectedProjects.length}</p>`;
        summaryHtml += `<p><strong>CAPEX total:</strong> $${totalCapex.toLocaleString('es-ES')} MM</p>`;
        summaryHtml += `<p><strong>CAPEX promedio:</strong> $${avgCapex.toLocaleString('es-ES')} MM</p>`;
        summaryHtml += `<p><strong>Sectores:</strong> ${Array.from(sectores).join(', ') || '-'}</p>`;
        summaryHtml += `<p><strong>Países:</strong> ${Array.from(paises).join(', ') || '-'}</p>`;
        summaryHtml += `<p><strong>Etapas:</strong> ${Array.from(etapas).join(', ') || '-'}</p>`;
        summaryHtml += `<p><strong>Estados:</strong> ${Array.from(estados).join(', ') || '-'}</p>`;
        summaryHtml += `<p><strong>Empresas involucradas:</strong> ${Array.from(empresas).join(', ') || '-'}</p>`;
        // Datos para gráficos
        const sectorCapex = {};
        const sectorEtapaCounts = {};
        const companyCapex = {};
        const countryCounts = {};
        selectedProjects.forEach(p => {
            const capex = p.capex || 0;
            sectorCapex[p.sector] = (sectorCapex[p.sector] || 0) + capex;
            if (!sectorEtapaCounts[p.sector]) sectorEtapaCounts[p.sector] = {};
            sectorEtapaCounts[p.sector][p.etapa] = (sectorEtapaCounts[p.sector][p.etapa] || 0) + 1;
            toArray(p.companias).forEach(c => {
                companyCapex[c] = (companyCapex[c] || 0) + capex;
            });
            countryCounts[p.pais] = (countryCounts[p.pais] || 0) + 1;
        });
        const sectorLabels = Object.keys(sectorCapex);
        const sectorValues = Object.values(sectorCapex);
        const topList = [...selectedProjects].sort((a,b)=> (b.capex||0) - (a.capex||0)).slice(0,5);
        const topLabels = topList.map(p=>p.name);
        const topValues = topList.map(p=>p.capex||0);
        const etapaLabels = Array.from(new Set(selectedProjects.map(p=>p.etapa)));
        const stackedLabels = Object.keys(sectorEtapaCounts);
        // La variable stackedDatasets ya no se utiliza porque los gráficos se generan manualmente.
        const stackedDatasets = [];
        const companyEntries = Object.entries(companyCapex).sort((a,b)=> b[1]-a[1]).slice(0,5);
        const companyLabels = companyEntries.map(e=>e[0]);
        const companyValues = companyEntries.map(e=>e[1]);
        const countryLabels = Object.keys(countryCounts);
        const countryValues = Object.values(countryCounts);
        // Generar gráficos
        const charts = {};
        // En ausencia de bibliotecas externas, utilizamos gráficos de barras simples.  Si
        // un gráfico no está seleccionado, se omite.  Los gráficos horizontales se
        // utilizan para inversiones por compañía y proyectos por país.
        if (chartSelection.sector) {
            charts.sector = createBarChart(sectorLabels, sectorValues, 'CAPEX por Sector', false);
        }
        if (chartSelection.top) {
            charts.top = createBarChart(topLabels, topValues, 'Top Proyectos por CAPEX', false);
        }
        if (chartSelection.stacked) {
            // Para la distribución de etapas generamos un gráfico por etapas totales
            const etapaCounts = etapaLabels.map(et => selectedProjects.filter(p => p.etapa === et).length);
            charts.stacked = createBarChart(etapaLabels, etapaCounts, 'Distribución de Etapas', false);
        }
        if (chartSelection.company) {
            charts.company = createBarChart(companyLabels, companyValues, 'Inversión por Compañía', true);
        }
        if (chartSelection.country) {
            charts.country = createBarChart(countryLabels, countryValues, 'Proyectos por País', true);
        }
        // Detalle por proyecto
        let detailsHtml = '';
        selectedProjects.forEach(p => {
            detailsHtml += `<h4 style="margin-top:15px; color:#0055A6;">${p.name}</h4>`;
            detailsHtml += '<table style="width:100%; border-collapse:collapse; font-size:0.85rem;">';
            const rows = [
                { label:'Sector', value:p.sector || '-' },
                { label:'Área', value:p.area || '-' },
                { label:'País', value:p.pais || '-' },
                { label:'Etapa', value:p.etapa || '-' },
                { label:'Estado', value:p.estado || '-' },
                { label:'CAPEX (US$ MM)', value:p.capex || '-' },
                { label:'Productos', value: toArray(p.productos).join(', ') || '-' },
                { label:'Empresas', value: toArray(p.companias).join(', ') || '-' }
            ];
            rows.forEach(r => {
                detailsHtml += `<tr><td style="padding:4px 8px; font-weight:bold; border:1px solid #e0e7ff; background:#f8fafd;">${r.label}</td><td style="padding:4px 8px; border:1px solid #e0e7ff;">${r.value}</td></tr>`;
            });
            detailsHtml += '</table>';
        });
        // Construir vista previa según la selección de gráficos
        let previewHtml = '';
        previewHtml += `<div>${summaryHtml}</div>`;
        // Orden predeterminado de gráficos
        if (chartSelection.sector && charts.sector) {
            previewHtml += '<h4 style="margin-top:10px; color:#0055A6;">CAPEX por Sector</h4>';
            previewHtml += `<img src="${charts.sector}" style="max-width:100%; height:auto; margin-bottom:10px;"/>`;
        }
        if (chartSelection.top && charts.top) {
            previewHtml += '<h4 style="margin-top:10px; color:#0055A6;">Top Proyectos por CAPEX</h4>';
            previewHtml += `<img src="${charts.top}" style="max-width:100%; height:auto; margin-bottom:10px;"/>`;
        }
        if (chartSelection.stacked && charts.stacked) {
            previewHtml += '<h4 style="margin-top:10px; color:#0055A6;">Distribución de Etapas por Sector</h4>';
            previewHtml += `<img src="${charts.stacked}" style="max-width:100%; height:auto; margin-bottom:10px;"/>`;
        }
        if (chartSelection.company && charts.company) {
            previewHtml += '<h4 style="margin-top:10px; color:#0055A6;">Inversión por Compañía</h4>';
            previewHtml += `<img src="${charts.company}" style="max-width:100%; height:auto; margin-bottom:10px;"/>`;
        }
        if (chartSelection.country && charts.country) {
            previewHtml += '<h4 style="margin-top:10px; color:#0055A6;">Proyectos por País</h4>';
            previewHtml += `<img src="${charts.country}" style="max-width:100%; height:auto; margin-bottom:10px;"/>`;
        }
        previewHtml += `<div>${detailsHtml}</div>`;
        document.getElementById('report-preview').innerHTML = previewHtml;
        // Guardar datos para exportación
        currentReportData = { selectedProjects, reportType, charts, summaryHtml, detailsHtml, totalCapex, avgCapex, selectedCharts: Object.assign({}, chartSelection) };
        document.getElementById('download-buttons').style.display = 'block';
        // Habilitar los botones de exportación en la barra superior
        const pdfT = document.getElementById('pdf-btn-top');
        const excelT = document.getElementById('excel-btn-top');
        const wordT = document.getElementById('word-btn-top');
        if (pdfT) pdfT.disabled = false;
        if (excelT) excelT.disabled = false;
        if (wordT) wordT.disabled = false;
    }

    // Exporta el reporte como PDF/Excel/Word
    function exportReport(format) {
        if (!currentReportData) { alert('Genera un reporte primero'); return; }
        const data = currentReportData;
        if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            let y = 40;
            doc.setFontSize(16);
            doc.text('Reporte de Proyectos Mineros', 40, y);
            y += 18;
            doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-CL')}`, 40, y);
            y += 20;
            const tmpDiv = document.createElement('div');
            tmpDiv.innerHTML = data.summaryHtml;
            const summaryText = tmpDiv.textContent || '';
            const lines = doc.splitTextToSize(summaryText, 520);
            doc.setFontSize(10);
            doc.text(lines, 40, y);
            y += lines.length * 12 + 10;
            const insert = (img, title) => {
                if (!img) return;
                if (y + 310 > 800) { doc.addPage(); y = 40; }
                doc.setFontSize(12);
                doc.text(title, 40, y);
                y += 14;
                doc.addImage(img, 'PNG', 40, y, 520, 260);
                y += 270;
            };
            // Insertar sólo los gráficos seleccionados
            const selCharts = data.selectedCharts || {};
            if (selCharts.sector) {
                insert(data.charts.sector, 'CAPEX por Sector');
            }
            if (selCharts.top) {
                insert(data.charts.top, 'Top Proyectos por CAPEX');
            }
            if (selCharts.stacked) {
                insert(data.charts.stacked, 'Distribución de Etapas por Sector');
            }
            if (selCharts.company) {
                insert(data.charts.company, 'Inversión por Compañía');
            }
            if (selCharts.country) {
                insert(data.charts.country, 'Proyectos por País');
            }
            // Tabla de detalles
            const tableBody = [];
            data.selectedProjects.forEach(p => {
                tableBody.push([
                    p.name,
                    p.sector || '-',
                    p.pais || '-',
                    p.etapa || '-',
                    p.capex || '-',
                    p.estado || '-',
                    toArray(p.productos).join(', ') || '-',
                    toArray(p.companias).join(', ') || '-'
                ]);
            });
            if (y + 20 > 700) { doc.addPage(); y = 40; }
            doc.autoTable({
                head: [['Nombre','Sector','País','Etapa','CAPEX','Estado','Productos','Empresas']],
                body: tableBody,
                startY: y,
                margin: { left: 40 },
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0,85,166], textColor: [255,255,255] }
            });
            doc.save('reporte_proyectos.pdf');
        } else if (format === 'excel') {
            const wb = XLSX.utils.book_new();
            const summarySheet = [['Métrica','Valor']];
            summarySheet.push(['Proyectos seleccionados', data.selectedProjects.length]);
            summarySheet.push(['CAPEX total (US$ MM)', data.totalCapex]);
            summarySheet.push(['CAPEX promedio (US$ MM)', data.avgCapex]);
            summarySheet.push(['Sectores', Array.from(new Set(data.selectedProjects.map(p => p.sector))).join(', ') || '-']);
            summarySheet.push(['Países', Array.from(new Set(data.selectedProjects.map(p => p.pais))).join(', ') || '-']);
            summarySheet.push(['Etapas', Array.from(new Set(data.selectedProjects.map(p => p.etapa))).join(', ') || '-']);
            summarySheet.push(['Estados', Array.from(new Set(data.selectedProjects.map(p => p.estado))).join(', ') || '-']);
            summarySheet.push(['Empresas', Array.from(new Set([].concat(...data.selectedProjects.map(p => toArray(p.companias))))).join(', ') || '-']);
            const wsSummary = XLSX.utils.aoa_to_sheet(summarySheet);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen');
            const detailRows = [['Nombre','Sector','País','Etapa','CAPEX (US$ MM)','Estado','Productos','Empresas']];
            data.selectedProjects.forEach(p => {
                detailRows.push([
                    p.name,
                    p.sector || '-',
                    p.pais || '-',
                    p.etapa || '-',
                    p.capex || '-',
                    p.estado || '-',
                    toArray(p.productos).join(', ') || '-',
                    toArray(p.companias).join(', ') || '-'
                ]);
            });
            const wsDetail = XLSX.utils.aoa_to_sheet(detailRows);
            XLSX.utils.book_append_sheet(wb, wsDetail, 'Detalles');
            XLSX.writeFile(wb, 'reporte_proyectos.xlsx');
        } else if (format === 'word') {
            const blob = new Blob([
                `<!doctype html><html><head><meta charset="utf-8"></head><body>${data.summaryHtml}${document.getElementById('report-preview').innerHTML}</body></html>`
            ], { type:'application/msword' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'reporte_proyectos.doc';
            a.click();
            URL.revokeObjectURL(a.href);
        }
    }

    // Manejo de archivos cargados por el usuario
    // Cuando el usuario selecciona un archivo se guarda en la variable pendingFile y se muestra el botón "Aceptar".
    document.getElementById('data-source').addEventListener('change', (e) => {
        pendingFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
        const btn = document.getElementById('load-data-btn');
        if (btn) {
            btn.style.display = pendingFile ? 'inline-block' : 'none';
        }
    });

    // Procesar archivo cuando el usuario haga clic en "Aceptar".  Esto permite al usuario cancelar la selección
    // o cargar el archivo de forma explícita.  Tras la carga se limpian filtros y se actualizan KPI.
    document.getElementById('load-data-btn').addEventListener('click', async () => {
        if (!pendingFile) return;
        const file = pendingFile;
        pendingFile = null;
        const btn = document.getElementById('load-data-btn');
        if (btn) btn.style.display = 'none';
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        try {
            if (ext === 'json') {
                const text = await file.text();
                const data = JSON.parse(text);
                projects = data.map(row => normalizeRow(row));
            } else if (ext === 'xlsx' || ext === 'xls') {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                projects = jsonData.map(row => normalizeRow(row));
            } else {
                alert('Formato no soportado. Carga un .xlsx o .json');
                return;
            }
            // Reiniciar filtros y listas
            filteredProjects = [];
            renderProjectsList();
            populateFilters();
            updateKPIs();
        } catch (err) {
            console.error('Error cargando archivo', err);
            alert('Error al cargar archivo');
        }
    });

    document.getElementById('generate-btn').addEventListener('click', generateReport);
    document.getElementById('pdf-btn').addEventListener('click', () => exportReport('pdf'));
    document.getElementById('excel-btn').addEventListener('click', () => exportReport('excel'));
    document.getElementById('word-btn').addEventListener('click', () => exportReport('word'));

    // Buscar por nombre: actualiza searchTerm y vuelve a renderizar la lista
    const searchInputEl = document.getElementById('search-input');
    if (searchInputEl) {
        searchInputEl.addEventListener('input', (e) => {
            searchTerm = (e.target.value || '').trim();
            renderProjectsList();
        });
    }

    // Vincular los botones superiores de exportación a la función exportReport
    const pdfTopBtn = document.getElementById('pdf-btn-top');
    const excelTopBtn = document.getElementById('excel-btn-top');
    const wordTopBtn = document.getElementById('word-btn-top');
    if (pdfTopBtn) {
        pdfTopBtn.addEventListener('click', () => exportReport('pdf'));
    }
    if (excelTopBtn) {
        excelTopBtn.addEventListener('click', () => exportReport('excel'));
    }
    if (wordTopBtn) {
        wordTopBtn.addEventListener('click', () => exportReport('word'));
    }

    // Aplicar filtros cuando el usuario lo solicite
    const applyBtn = document.getElementById('apply-filters');
    if (applyBtn) {
        applyBtn.addEventListener('click', applyFilters);
    }

    // Actualizar opciones de gráficos cuando cambia el tipo de reporte
    const reportTypeSelect = document.getElementById('report-type');
    if (reportTypeSelect) {
        reportTypeSelect.addEventListener('change', (e) => {
            renderChartOptions(e.target.value);
        });
    }

    // Cargar datos al iniciar
    loadInitialData();
    // Poblamos filtros y opciones de gráficos con la selección inicial
    document.addEventListener('DOMContentLoaded', () => {
        // Solo configuramos las opciones de gráficos aquí; los filtros se generan
        // cuando los datos están disponibles en loadInitialData().
        renderChartOptions(document.getElementById('report-type').value);
    });
    </script>
</body>
</html>
